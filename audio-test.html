<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Test - GupShup Cafe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .audio-level {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .audio-level-bar {
            height: 100%;
            background-color: #28a745;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 Audio System Test</h1>
        <p>Use this page to test your microphone and audio setup before joining discussions.</p>

        <div class="test-section">
            <h3>1. Browser Compatibility</h3>
            <div id="browserStatus" class="status info">Checking browser support...</div>
        </div>

        <div class="test-section">
            <h3>2. Microphone Permission</h3>
            <button id="requestMic">Request Microphone Access</button>
            <div id="micStatus" class="status info">Click the button above to test microphone access</div>
        </div>

        <div class="test-section">
            <h3>3. Audio Level Test</h3>
            <div id="audioLevelContainer" style="display: none;">
                <p>Speak into your microphone to see the audio level:</p>
                <div class="audio-level">
                    <div id="audioLevelBar" class="audio-level-bar" style="width: 0%;"></div>
                </div>
                <p>Audio Level: <span id="audioLevelText">0</span></p>
                <button id="toggleMute">Mute/Unmute</button>
            </div>
        </div>

        <div class="test-section">
            <h3>4. Connection Test</h3>
            <button id="testConnection">Test Platform Connection</button>
            <div id="connectionStatus" class="status info">Click to test connection to the platform</div>
        </div>
    </div>

    <script>
        let audioStream = null;
        let audioContext = null;
        let analyser = null;
        let isMuted = false;

        // Check browser compatibility
        function checkBrowserSupport() {
            const browserStatus = document.getElementById('browserStatus');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                browserStatus.className = 'status error';
                browserStatus.textContent = '❌ Your browser does not support WebRTC audio. Try Chrome, Firefox, or Edge.';
                return false;
            }
            
            browserStatus.className = 'status success';
            browserStatus.textContent = '✅ Browser supports WebRTC audio';
            return true;
        }

        // Request microphone access
        async function requestMicrophone() {
            const micStatus = document.getElementById('micStatus');
            const requestButton = document.getElementById('requestMic');
            
            try {
                requestButton.disabled = true;
                micStatus.className = 'status info';
                micStatus.textContent = '🔄 Requesting microphone access...';

                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });

                micStatus.className = 'status success';
                micStatus.textContent = '✅ Microphone access granted!';
                
                setupAudioLevelMonitoring();
                
            } catch (error) {
                console.error('Microphone error:', error);
                micStatus.className = 'status error';
                
                if (error.name === 'NotAllowedError') {
                    micStatus.textContent = '❌ Microphone access denied. Please click the microphone icon in your browser bar and allow access.';
                } else if (error.name === 'NotFoundError') {
                    micStatus.textContent = '❌ No microphone found. Please check your device settings.';
                } else {
                    micStatus.textContent = `❌ Error: ${error.message}`;
                }
                requestButton.disabled = false;
            }
        }

        // Set up audio level monitoring
        function setupAudioLevelMonitoring() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(audioStream);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                document.getElementById('audioLevelContainer').style.display = 'block';
                
                updateAudioLevel();
            } catch (error) {
                console.error('Audio monitoring error:', error);
            }
        }

        // Update audio level visualization
        function updateAudioLevel() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const percentage = Math.min((average / 50) * 100, 100);
            
            document.getElementById('audioLevelBar').style.width = percentage + '%';
            document.getElementById('audioLevelText').textContent = Math.round(average);
            
            if (audioStream && audioStream.active) {
                requestAnimationFrame(updateAudioLevel);
            }
        }

        // Toggle mute
        function toggleMute() {
            if (!audioStream) return;
            
            isMuted = !isMuted;
            audioStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });
            
            const button = document.getElementById('toggleMute');
            button.textContent = isMuted ? 'Unmute' : 'Mute';
            button.style.backgroundColor = isMuted ? '#dc3545' : '#28a745';
        }

        // Test platform connection
        async function testConnection() {
            const connectionStatus = document.getElementById('connectionStatus');
            const testButton = document.getElementById('testConnection');
            
            try {
                testButton.disabled = true;
                connectionStatus.className = 'status info';
                connectionStatus.textContent = '🔄 Testing connection to platform...';

                // Test backend connection
                const response = await fetch('https://gupshup-cafe.onrender.com/health');
                
                if (response.ok) {
                    connectionStatus.className = 'status success';
                    connectionStatus.textContent = '✅ Platform connection successful! You can now join discussions.';
                } else {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                connectionStatus.className = 'status error';
                connectionStatus.textContent = `❌ Connection failed: ${error.message}`;
            } finally {
                testButton.disabled = false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkBrowserSupport();
            
            document.getElementById('requestMic').addEventListener('click', requestMicrophone);
            document.getElementById('toggleMute').addEventListener('click', toggleMute);
            document.getElementById('testConnection').addEventListener('click', testConnection);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
